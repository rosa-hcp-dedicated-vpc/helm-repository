{{- if .Values.clusterPolicy.enabled }}
apiVersion: nvidia.com/v1
kind: ClusterPolicy
metadata:
  name: {{ .Values.clusterPolicy.name }}
  annotations:
    argocd.argoproj.io/sync-wave: "{{ add .Values.syncwave 3 }}"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true,Validate=false
spec:
  # Operator configuration
  operator:
    defaultRuntime: {{ .Values.clusterPolicy.operator.defaultRuntime }}
  # NVIDIA Driver
  driver:
    enabled: {{ .Values.clusterPolicy.driver.enabled }}
    {{- if .Values.clusterPolicy.driver.repository }}
    repository: {{ .Values.clusterPolicy.driver.repository }}
    {{- end }}
    {{- if .Values.clusterPolicy.driver.version }}
    version: {{ .Values.clusterPolicy.driver.version }}
    {{- end }}
  # NVIDIA Container Toolkit
  toolkit:
    enabled: {{ .Values.clusterPolicy.toolkit.enabled }}
  # Device Plugin
  devicePlugin:
    enabled: {{ .Values.clusterPolicy.devicePlugin.enabled }}
  # DCGM (Data Center GPU Manager)
  dcgm:
    enabled: {{ .Values.clusterPolicy.dcgm.enabled }}
  # DCGM Exporter for monitoring
  dcgmExporter:
    enabled: {{ .Values.clusterPolicy.dcgmExporter.enabled }}
  # GPU Feature Discovery
  gfd:
    enabled: {{ .Values.clusterPolicy.gfd.enabled }}
  # Daemonsets configuration
  daemonsets:
    tolerations:
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoSchedule
    updateStrategy: RollingUpdate
    rollingUpdate:
      maxUnavailable: "1"
  # Optional components
  migManager:
    enabled: {{ .Values.clusterPolicy.migManager.enabled }}
  nodeStatusExporter:
    enabled: {{ .Values.clusterPolicy.nodeStatusExporter.enabled }}
  gds:
    enabled: {{ .Values.clusterPolicy.gds.enabled }}
  cdi:
    enabled: {{ .Values.clusterPolicy.cdi.enabled }}
  vgpuManager:
    enabled: {{ .Values.clusterPolicy.vgpuManager.enabled }}
  vgpuDeviceManager:
    enabled: {{ .Values.clusterPolicy.vgpuDeviceManager.enabled }}
  sandboxWorkloads:
    enabled: {{ .Values.clusterPolicy.sandboxWorkloads.enabled }}
  vfioManager:
    enabled: {{ .Values.clusterPolicy.vfioManager.enabled }}
{{- end }}
