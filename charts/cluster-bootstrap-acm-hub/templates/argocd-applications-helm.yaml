---
{{ range $applications := .Values.argocd.applications -}}
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: {{ $applications.name }}-applicationset
  namespace: openshift-gitops
  annotations:
    # ACM placement
    apps.open-cluster-management.io/ocm-managed-cluster: '{{name}}'
    apps.open-cluster-management.io/ocm-managed-cluster-app-namespace: openshift-gitops
    argocd.argoproj.io/skip-reconcile: "true"
    argocd.argoproj.io/compare-options: IgnoreExtraneous
    argocd.argoproj.io/sync-wave: '3'
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
  {{- range $key, $value := $applications.annotations }}
    {{ $key }}: {{ $value | quote }}
  {{- end }}
spec:
  generators:
  - list:
      elements:
      - cluster: in-cluster
        url: https://kubernetes.default.svc
  template:
    metadata:
      name: {{ $applications.name }}
      namespace: openshift-gitops
      annotations:
        argocd.argoproj.io/compare-options: IgnoreExtraneous
    spec:
      destination:
        namespace: openshift-gitops
        server: https://kubernetes.default.svc
      project: {{ $applications.project }}
      sources:
        - repoURL: {{ $applications.helmRepoUrl }}
          chart: {{ $applications.chart }}
          targetRevision: {{ $applications.targetRevision }}
          path: /charts
          helm:
            valueFiles:
            - $values/{{ $.Values.environment }}/{{ $.Values.clusterName }}/{{ $applications.gitPathFile }}
            values: |
              appTeam: {{ $applications.name }}
        - repoURL: {{ $applications.gitRepoUrl }}
          targetRevision: HEAD
          ref: values
      syncPolicy:
        automated:
          prune: false
          selfHeal: true
        syncOptions:
        - ApplyOutOfSyncOnly=true
        - CreateNamespace=true
---
{{ end }}
