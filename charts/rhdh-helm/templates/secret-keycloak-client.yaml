apiVersion: batch/v1
kind: Job
metadata:
  name: copy-keycloak-secret-{{ .Release.Revision }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ .Release.Name }}
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  template:
    spec:
      serviceAccountName: keycloak-secret-copier
      restartPolicy: Never
      containers:
      - name: secret-copier
        image: registry.redhat.io/openshift4/ose-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          
          # Wait for Keycloak to be ready and admin secret to be available
          echo "Waiting for Keycloak admin secret to be available..."
          TIMEOUT=300  # 5 minutes timeout
          COUNTER=0
          
          while [ $COUNTER -lt $TIMEOUT ]; do
            if oc get secret keycloak-backstage-initial-admin -n rhbk-operator >/dev/null 2>&1; then
              echo "Keycloak admin secret found! Proceeding..."
              break
            else
              echo "Admin secret not found yet. Waiting... ($COUNTER/$TIMEOUT seconds)"
              sleep 10
              COUNTER=$((COUNTER + 10))
            fi
          done
          
          if [ $COUNTER -ge $TIMEOUT ]; then
            echo "ERROR: Timeout waiting for Keycloak admin secret"
            exit 1
          fi
          
          # Get admin credentials
          echo "Retrieving Keycloak admin credentials..."
          ADMIN_USER=$(oc get secret keycloak-backstage-initial-admin -n rhbk-operator -o jsonpath='{.data.username}' | base64 -d)
          ADMIN_PASS=$(oc get secret keycloak-backstage-initial-admin -n rhbk-operator -o jsonpath='{.data.password}' | base64 -d)
          KEYCLOAK_URL="{{ .Values.keycloakUrl | default "holder" }}"
          
          echo "Authenticating with Keycloak admin API..."
          # Get admin token
          ADMIN_TOKEN=$(curl -s -k -X POST \
            "$KEYCLOAK_URL/realms/master/protocol/openid-connect/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "username=$ADMIN_USER" \
            -d "password=$ADMIN_PASS" \
            -d "grant_type=password" \
            -d "client_id=admin-cli" | \
            jq -r '.access_token // empty')
          
          if [ -z "$ADMIN_TOKEN" ] || [ "$ADMIN_TOKEN" = "null" ]; then
            echo "ERROR: Failed to get admin token from Keycloak"
            exit 1
          fi
          
          echo "Retrieving backstage client secret from Keycloak..."
          # Get client secret for backstage client
          CLIENT_SECRET=$(curl -s -k -X GET \
            "$KEYCLOAK_URL/admin/realms/backstage/clients" \
            -H "Authorization: Bearer $ADMIN_TOKEN" | \
            jq -r '.[] | select(.clientId=="backstage") | .secret // empty')
          
          if [ -z "$CLIENT_SECRET" ] || [ "$CLIENT_SECRET" = "null" ]; then
            echo "ERROR: Failed to retrieve client secret for backstage client"
            exit 1
          fi
          
          echo "Creating keycloak-client-secret-backstage secret in {{ .Release.Namespace }} namespace..."
          # Create the expected secret format
          oc create secret generic keycloak-client-secret-backstage \
            --from-literal=CLIENT_ID=backstage \
            --from-literal=CLIENT_SECRET="$CLIENT_SECRET" \
            -n {{ .Release.Namespace }} \
            --dry-run=client -o yaml | oc apply -f -
          
          echo "Secret successfully created in {{ .Release.Namespace }} namespace!"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keycloak-secret-copier
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: keycloak-secret-copier
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
rules:
- apiGroups: [""]
  resources: ["secrets", "namespaces"]
  verbs: ["get", "list", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: keycloak-secret-copier-{{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
subjects:
- kind: ServiceAccount
  name: keycloak-secret-copier
  namespace: {{ .Release.Namespace }}
roleRef:
  kind: ClusterRole
  name: keycloak-secret-copier
  apiGroup: rbac.authorization.k8s.io
