---
apiVersion: batch/v1
kind: Job
metadata:
  name: generate-backend-secret
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-wave: "-2"
spec:
  template:
    spec:
      serviceAccountName: backend-secret-generator
      restartPolicy: Never
      containers:
      - name: secret-generator
        image: registry.redhat.io/openshift4/ose-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          #!/bin/bash
          set -e
          
          echo "Checking if backend secret already exists..."
          
          # Check if secret already exists
          if oc get secret backstage-backend-secret -n {{ .Release.Namespace }} >/dev/null 2>&1; then
            echo "Secret 'backstage-backend-secret' already exists. Skipping generation."
            exit 0
          fi
          
          echo "Generating new BACKEND_SECRET..."
          
          # Generate a random 24-character alphanumeric string
          BACKEND_SECRET=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 24 | head -n 1)
          
          if [ -z "$BACKEND_SECRET" ]; then
            echo "ERROR: Failed to generate BACKEND_SECRET"
            exit 1
          fi
          
          echo "BACKEND_SECRET generated successfully (length: ${#BACKEND_SECRET})"
          
          # Create secret with the backend secret
          oc create secret generic backstage-backend-secret \
            --from-literal=backend-secret="$BACKEND_SECRET" \
            -n {{ .Release.Namespace }} \
            --dry-run=client -o yaml | oc apply -f -
          
          echo "Secret 'backstage-backend-secret' created successfully in {{ .Release.Namespace }} namespace"
          echo "This secret will persist across deployments and should not be regenerated."
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: backend-secret-generator
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "-3"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: backend-secret-generator
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "-3"
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: backend-secret-generator
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "-3"
subjects:
- kind: ServiceAccount
  name: backend-secret-generator
  namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: backend-secret-generator
  apiGroup: rbac.authorization.k8s.io


