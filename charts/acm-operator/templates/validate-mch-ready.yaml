---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mch-validator
  namespace: open-cluster-management
  annotations:
    argocd.argoproj.io/sync-wave: "5"
    argocd.argoproj.io/hook: Sync
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: mch-validator
  annotations:
    argocd.argoproj.io/sync-wave: "5"
    argocd.argoproj.io/hook: Sync
rules:
- apiGroups:
  - operator.open-cluster-management.io
  resources:
  - multiclusterhubs
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: mch-validator
  annotations:
    argocd.argoproj.io/sync-wave: "5"
    argocd.argoproj.io/hook: Sync
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: mch-validator
subjects:
- kind: ServiceAccount
  name: mch-validator
  namespace: open-cluster-management
---
apiVersion: batch/v1
kind: Job
metadata:
  name: validate-mch-ready
  namespace: open-cluster-management
  annotations:
    argocd.argoproj.io/sync-wave: "6"
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 0
  template:
    metadata:
      name: validate-mch-ready
    spec:
      serviceAccountName: mch-validator
      restartPolicy: Never
      containers:
      - name: validator
        image: registry.redhat.io/openshift4/ose-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          #!/bin/bash
          set -e
          
          echo "Starting MultiClusterHub validation..."
          echo "Will check every 30 seconds for up to 20 minutes (40 attempts)"
          
          MAX_ATTEMPTS=40
          SLEEP_INTERVAL=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."
            
            # Get the MultiClusterHub status
            MCH_STATUS=$(oc get multiclusterhub multiclusterhub -n open-cluster-management -o jsonpath='{.status.phase}' 2>/dev/null || echo "NotFound")
            
            echo "Current MultiClusterHub status: $MCH_STATUS"
            
            if [ "$MCH_STATUS" == "Running" ]; then
              echo "✓ MultiClusterHub is Running!"
              
              # Double-check that currentVersion is populated
              CURRENT_VERSION=$(oc get multiclusterhub multiclusterhub -n open-cluster-management -o jsonpath='{.status.currentVersion}' 2>/dev/null || echo "")
              
              if [ -n "$CURRENT_VERSION" ]; then
                echo "✓ Current version: $CURRENT_VERSION"
                echo "✓ MultiClusterHub is fully ready!"
                
                # Verify critical CRDs are available
                echo "Verifying critical CRDs..."
                if oc api-resources | grep -q "placements.*cluster.open-cluster-management.io"; then
                  echo "✓ Placement CRD is available"
                else
                  echo "⚠ Warning: Placement CRD not yet available, waiting..."
                  sleep $SLEEP_INTERVAL
                  continue
                fi
                
                if oc api-resources | grep -q "managedclustersetbindings.*cluster.open-cluster-management.io"; then
                  echo "✓ ManagedClusterSetBinding CRD is available"
                else
                  echo "⚠ Warning: ManagedClusterSetBinding CRD not yet available, waiting..."
                  sleep $SLEEP_INTERVAL
                  continue
                fi
                
                if oc api-resources | grep -q "gitopsclusters.*apps.open-cluster-management.io"; then
                  echo "✓ GitOpsCluster CRD is available"
                else
                  echo "⚠ Warning: GitOpsCluster CRD not yet available, waiting..."
                  sleep $SLEEP_INTERVAL
                  continue
                fi
                
                echo ""
                echo "=========================================="
                echo "✓ MultiClusterHub validation successful!"
                echo "=========================================="
                exit 0
              else
                echo "⚠ MultiClusterHub is Running but currentVersion is not yet populated. Waiting..."
              fi
            elif [ "$MCH_STATUS" == "Installing" ] || [ "$MCH_STATUS" == "Updating" ]; then
              echo "MultiClusterHub is still installing/updating. Waiting..."
            elif [ "$MCH_STATUS" == "NotFound" ]; then
              echo "✗ MultiClusterHub resource not found!"
              exit 1
            else
              echo "✗ Unexpected MultiClusterHub status: $MCH_STATUS"
              
              # Get more details about the failure
              echo "Checking for error conditions..."
              oc get multiclusterhub multiclusterhub -n open-cluster-management -o yaml | grep -A 10 "conditions:" || true
              
              if [ "$MCH_STATUS" == "Failed" ] || [ "$MCH_STATUS" == "Error" ]; then
                echo "✗ MultiClusterHub installation failed!"
                exit 1
              fi
            fi
            
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Waiting $SLEEP_INTERVAL seconds before next check..."
              sleep $SLEEP_INTERVAL
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "✗ Timeout: MultiClusterHub did not become ready within 20 minutes"
          echo "=========================================="
          echo "Final status:"
          oc get multiclusterhub multiclusterhub -n open-cluster-management -o yaml || true
          exit 1

