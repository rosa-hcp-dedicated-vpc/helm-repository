name: Release Charts

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-charts: ${{ steps.changed-charts.outputs.charts }}
      has-changes: ${{ steps.changed-charts.outputs.has-changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed charts
        id: changed-charts
        run: |
          # Get list of changed Chart.yaml files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep "charts/.*/Chart.yaml" || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No chart changes detected"
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "charts=[]" >> $GITHUB_OUTPUT
          else
            echo "Changed Chart.yaml files:"
            echo "$CHANGED_FILES"
            
            # Extract chart names
            CHANGED_CHARTS=$(echo "$CHANGED_FILES" | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1]')
            echo "Changed charts: $CHANGED_CHARTS"
            
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "charts=$CHANGED_CHARTS" >> $GITHUB_OUTPUT
          fi

  release:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        chart: ${{ fromJson(needs.detect-changes.outputs.changed-charts) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "root"
          git config user.email "root@users.noreply.github.com"

      - name: Run chart-releaser for ${{ matrix.chart }}
        uses: helm/chart-releaser-action@v1.7.0
        with:
          charts_dir: charts
          config: cr.yaml
        env:
          CR_TOKEN: "${{ secrets.HELM }}"
        continue-on-error: true

      - name: Report status
        run: |
          echo "ðŸ“Š Processed chart: ${{ matrix.chart }}"